FROM codercom/enterprise-base:ubuntu

# Run everything as root
USER root

RUN apt-get update -y && \
    apt-get install nano -y

RUN apt-get update -y

# Install go
RUN curl -L "https://go.dev/dl/go1.25.0.linux-amd64.tar.gz" | tar -C /usr/local -xzvf -

# Setup go env vars
ENV GOROOT=/usr/local/go
ENV PATH=$PATH:$GOROOT/bin

ENV GOPATH=/home/coder/go
ENV GOBIN=$GOPATH/bin
ENV PATH=$PATH:$GOBIN

# Install whichever Node version is LTS
RUN curl -sL https://deb.nodesource.com/setup_lts.x | bash -
RUN DEBIAN_FRONTEND="noninteractive" apt-get update -y && \
    apt-get install -y nodejs

# Install Yarn
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
RUN echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
RUN DEBIAN_FRONTEND="noninteractive" apt-get update && apt-get install -y yarn

# Install pnpm
RUN npm install --global corepack@latest && \
    corepack enable pnpm

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# Install rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | bash -s -- -y

RUN rustup component add rust-src
RUN rustup component add rust-analyzer

# Install codex
RUN npm install -g @openai/codex

# Install claude code
RUN npm install -g @anthropic-ai/claude-code

# Install lefthook
RUN go install github.com/evilmartians/lefthook@latest

# Install goimports
RUN go install golang.org/x/tools/cmd/goimports@latest

# Install golangci-lint
RUN curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | bash

# Install nix
RUN curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux \
  --extra-conf "system-features = kvm" \
  --init none \
  --no-confirm \
  --determinate

ENV PATH="${PATH}:/nix/var/nix/profiles/default/bin"

# Install nixd
RUN nix profile add github:nix-community/nixd
RUN nix profile add github:nixos/nixpkgs#just

# Set back to coder user
USER coder
